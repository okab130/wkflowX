{% extends 'workflow/base.html' %}

{% block title %}申請詳細 - {{ application.application_number }} - 業務ワークフローシステム{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <!-- ヘッダー -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2><i class="bi bi-file-text"></i> 申請詳細</h2>
                <p class="text-muted mb-0">申請番号: <strong>{{ application.application_number }}</strong></p>
            </div>
            <div>
                <a href="{% url 'workflow:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 一覧に戻る
                </a>
            </div>
        </div>

        <!-- ステータスと操作ボタン -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0">
                            現在のステータス:
                            {% if application.status == 'draft' %}
                            <span class="badge bg-secondary fs-6">{{ application.get_status_display }}</span>
                            {% elif application.status == 'submitted' %}
                            <span class="badge bg-info fs-6">{{ application.get_status_display }}</span>
                            {% elif application.status == 'received' %}
                            <span class="badge bg-warning fs-6">{{ application.get_status_display }}</span>
                            {% elif application.status == 'approved' %}
                            <span class="badge bg-success fs-6">{{ application.get_status_display }}</span>
                            {% elif application.status == 'rejected' %}
                            <span class="badge bg-danger fs-6">{{ application.get_status_display }}</span>
                            {% elif application.status == 'returned' %}
                            <span class="badge bg-warning fs-6">{{ application.get_status_display }}</span>
                            {% endif %}
                        </h5>
                    </div>
                    <div class="col-md-6 text-end">
                        {% if can_edit %}
                        <a href="{% url 'workflow:edit' application.pk %}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> 編集
                        </a>
                        {% endif %}
                        
                        {% if can_submit %}
                        <a href="{% url 'workflow:submit' application.pk %}" class="btn btn-success">
                            <i class="bi bi-send"></i> 申請提出
                        </a>
                        {% endif %}
                        
                        {% if can_receive %}
                        <a href="{% url 'workflow:receive' application.pk %}" class="btn btn-warning">
                            <i class="bi bi-inbox"></i> 受付処理
                        </a>
                        {% endif %}
                        
                        {% if can_approve %}
                        <a href="{% url 'workflow:approve' application.pk %}" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> 承認/却下
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 左側: 申請内容 -->
            <div class="col-lg-8">
                <!-- 基本情報 -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> 基本情報</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <tr>
                                <th width="30%" class="bg-light">申請種別</th>
                                <td><span class="badge bg-secondary">{{ application.get_application_type_display }}</span></td>
                            </tr>
                            <tr>
                                <th class="bg-light">タイトル</th>
                                <td><strong>{{ application.title }}</strong></td>
                            </tr>
                            <tr>
                                <th class="bg-light">申請内容</th>
                                <td style="white-space: pre-wrap;">{{ application.content }}</td>
                            </tr>
                            <tr>
                                <th class="bg-light">申請企業</th>
                                <td>{{ application.company_name }}</td>
                            </tr>
                            <tr>
                                <th class="bg-light">申請者</th>
                                <td>{{ application.applicant.username }} ({{ application.applicant.get_full_name|default:application.applicant.username }})</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- 作業情報 -->
                {% if application.work_location or application.work_start_date or application.worker_count %}
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-tools"></i> 作業情報</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            {% if application.work_location %}
                            <tr>
                                <th width="30%" class="bg-light">作業場所</th>
                                <td>{{ application.work_location }}</td>
                            </tr>
                            {% endif %}
                            {% if application.work_start_date %}
                            <tr>
                                <th class="bg-light">作業期間</th>
                                <td>
                                    {{ application.work_start_date|date:"Y年m月d日" }}
                                    {% if application.work_end_date %}
                                    ～ {{ application.work_end_date|date:"Y年m月d日" }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% if application.worker_count %}
                            <tr>
                                <th class="bg-light">作業人数</th>
                                <td>{{ application.worker_count }}名</td>
                            </tr>
                            {% endif %}
                            {% if application.contractor_name %}
                            <tr>
                                <th class="bg-light">施工業者</th>
                                <td>{{ application.contractor_name }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- 工具情報 -->
                {% if application.tool_list %}
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-wrench"></i> 工具情報</h5>
                    </div>
                    <div class="card-body">
                        <h6>持込工具リスト:</h6>
                        <pre class="bg-light p-3 rounded">{{ application.tool_list }}</pre>
                    </div>
                </div>
                {% endif %}

                <!-- 制限エリア情報 -->
                {% if application.restricted_area %}
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-shield-lock"></i> 制限エリア情報</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <tr>
                                <th width="30%" class="bg-light">制限エリア名</th>
                                <td>{{ application.restricted_area }}</td>
                            </tr>
                            {% if application.entry_purpose %}
                            <tr>
                                <th class="bg-light">立入目的</th>
                                <td style="white-space: pre-wrap;">{{ application.entry_purpose }}</td>
                            </tr>
                            {% endif %}
                            {% if application.entry_members %}
                            <tr>
                                <th class="bg-light">立入者リスト</th>
                                <td style="white-space: pre-wrap;">{{ application.entry_members }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- 添付ファイル -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-paperclip"></i> 添付ファイル</h5>
                    </div>
                    <div class="card-body">
                        {% if application.attachments.all %}
                        <div class="list-group">
                            {% for attachment in application.attachments.all %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-file-earmark"></i>
                                    <a href="{{ attachment.file.url }}" target="_blank">{{ attachment.file_name }}</a>
                                    <small class="text-muted">({{ attachment.get_file_size_display }})</small>
                                </div>
                                <div>
                                    <small class="text-muted">{{ attachment.uploaded_at|date:"Y/m/d H:i" }}</small>
                                    {% if can_edit %}
                                    <form method="post" action="{% url 'workflow:delete_attachment' application.pk attachment.pk %}" class="d-inline" onsubmit="return confirm('このファイルを削除しますか?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger ms-2">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted mb-0">添付ファイルはありません</p>
                        {% endif %}
                        
                        {% if can_edit %}
                        <hr>
                        <form method="post" action="{% url 'workflow:upload_attachment' application.pk %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="row align-items-end">
                                <div class="col-md-9">
                                    {{ attachment_form.file }}
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="bi bi-upload"></i> アップロード
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted">※ 10MB以内、PDF/Word/Excel/画像/ZIP形式</small>
                        </form>
                        {% endif %}
                    </div>
                </div>

                <!-- コメント -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> コメント</h5>
                    </div>
                    <div class="card-body">
                        {% if application.comments.all %}
                        <div class="list-group mb-3">
                            {% for comment in application.comments.all %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <strong>{{ comment.user.username }}</strong>
                                    <small class="text-muted">{{ comment.created_at|date:"Y/m/d H:i" }}</small>
                                </div>
                                <p class="mb-0 mt-2" style="white-space: pre-wrap;">{{ comment.content }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">コメントはありません</p>
                        {% endif %}
                        
                        <!-- コメント追加フォーム -->
                        <form method="post" action="{% url 'workflow:add_comment' application.pk %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                {{ comment_form.content }}
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i> コメント追加
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 右側: ワークフロー情報 -->
            <div class="col-lg-4">
                <!-- 日時情報 -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-clock-history"></i> 日時情報</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <strong>作成:</strong><br>
                                <small>{{ application.created_at|date:"Y/m/d H:i" }}</small>
                            </li>
                            {% if application.submitted_at %}
                            <li class="mb-2">
                                <strong>申請:</strong><br>
                                <small>{{ application.submitted_at|date:"Y/m/d H:i" }}</small>
                            </li>
                            {% endif %}
                            {% if application.received_at %}
                            <li class="mb-2">
                                <strong>受付:</strong><br>
                                <small>{{ application.received_at|date:"Y/m/d H:i" }}</small>
                            </li>
                            {% endif %}
                            {% if application.approved_at %}
                            <li class="mb-2">
                                <strong>承認:</strong><br>
                                <small>{{ application.approved_at|date:"Y/m/d H:i" }}</small>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>

                <!-- ワークフロー履歴 -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-activity"></i> ワークフロー履歴</h6>
                    </div>
                    <div class="card-body">
                        {% if application.workflow_steps.all %}
                        <div class="timeline">
                            {% for step in application.workflow_steps.all %}
                            <div class="mb-3 pb-3 border-bottom">
                                <div class="d-flex align-items-start">
                                    <div class="me-2">
                                        {% if step.step_type == 'submit' %}
                                        <i class="bi bi-send text-info"></i>
                                        {% elif step.step_type == 'receive' %}
                                        <i class="bi bi-inbox text-warning"></i>
                                        {% elif step.step_type == 'approve' %}
                                        <i class="bi bi-check-circle text-success"></i>
                                        {% elif step.step_type == 'reject' %}
                                        <i class="bi bi-x-circle text-danger"></i>
                                        {% elif step.step_type == 'return' %}
                                        <i class="bi bi-arrow-return-left text-warning"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between">
                                            <strong>{{ step.get_step_type_display }}</strong>
                                            <small class="text-muted">{{ step.processed_at|date:"m/d H:i" }}</small>
                                        </div>
                                        <small class="text-muted">{{ step.processor.username }}</small>
                                        {% if step.comment %}
                                        <p class="mb-0 mt-1 small" style="white-space: pre-wrap;">{{ step.comment }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted mb-0">履歴はありません</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
